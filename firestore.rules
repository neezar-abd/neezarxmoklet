rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions for validation
    function validName(n) { 
      return n is string && n.size() >= 2 && n.size() <= 20; 
    }
    
    function validMsg(m) { 
      return m is string && m.size() >= 3 && m.size() <= 280; 
    }

    // Guestbook collection rules
    match /guestbook/{id} {
      // Public can ONLY read approved entries
      allow read: if resource.data.approved == true;

      // Public can create new entries (pending approval)
      allow create: if
        validName(request.resource.data.username) &&
        validMsg(request.resource.data.message) &&
        request.resource.data.approved == false &&
        request.resource.data.createdAt is timestamp;

      // Public cannot update or delete entries
      allow update, delete: if false;
    }
  }
}

/**
 * DEPLOY INSTRUCTIONS:
 * 
 * 1. Copy the rules above
 * 2. Go to Firebase Console → Firestore Database → Rules
 * 3. Replace existing rules with the above
 * 4. Click "Publish"
 * 
 * KEY SECURITY FEATURES:
 * - Only approved entries are publicly readable
 * - New entries are automatically pending (approved: false)
 * - Username: 2-20 characters
 * - Message: 3-280 characters
 * - Timestamp validation
 * - No public updates/deletes
 */
